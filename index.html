<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>mod_mruby by matsumoto-r</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/matsumoto-r/mod_mruby">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/matsumoto-r/mod_mruby/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/matsumoto-r/mod_mruby/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>mod_mruby</h1>
          <p>A Fast and Memory-Efficient Web Server Extension Mechanism Using Scripting Language mruby for Apache httpd</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/matsumoto-r">matsumoto-r</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h1>
<a name="welcome-to-mod_mruby-pages" class="anchor" href="#welcome-to-mod_mruby-pages"><span class="octicon octicon-link"></span></a>Welcome to mod_mruby Pages</h1>

<h2>
<a name="whats-mod_mruby" class="anchor" href="#whats-mod_mruby"><span class="octicon octicon-link"></span></a>What's mod_mruby</h2>

<p><strong>mod_murby is A Fast and Memory-Efficient Web Server Extension Mechanism Using Scripting Language mruby for Apache httpd.</strong></p>

<ul>
<li>Unified Ruby Code between Apache(mod_mruby), nginx(ngx_mruby) and other Web server software(plan) for Web server extensions.</li>
<li>You can implement Apache modules by Ruby on Apache httpd.</li>
<li>You can implement some Web server software extensions by same Ruby code (as possible) </li>
<li>mod_mruby is to provide an alternative to mod_lua or <a href="http://matsumoto-r.github.io/ngx_mruby/">ngx_mruby of nginx</a>.</li>
<li>Supported Apache Version: <strong>2.0 2.2 2.4 2.5</strong>
</li>
<li>Supported Apache MPM: <strong>worker prefork event</strong>
</li>
<li>Supported OS: <strong>Linux FreeBSD Windows</strong> and so on.</li>
</ul><div class="highlight highlight-ruby"><pre><span class="c1"># Apache httpd.conf</span>
<span class="c1"># mrubyTranslateNameMiddle "/path/to/proxy.rb"</span>
<span class="c1">#</span>

<span class="n">backends</span> <span class="o">=</span> <span class="o">[</span>
  <span class="s2">"http://192.168.0.101:8888/"</span><span class="p">,</span>
  <span class="s2">"http://192.168.0.102:8888/"</span><span class="p">,</span>
  <span class="s2">"http://192.168.0.103:8888/"</span><span class="p">,</span>
  <span class="s2">"http://192.168.0.104:8888/"</span><span class="p">,</span>
<span class="o">]</span>

<span class="c1"># write balancing algorithm here.</span>

<span class="n">r</span> <span class="o">=</span> <span class="ss">Apache</span><span class="p">:</span><span class="ss">:Request</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">handler</span>  <span class="o">=</span> <span class="s2">"proxy-server"</span>
<span class="n">r</span><span class="o">.</span><span class="n">proxyreq</span> <span class="o">=</span> <span class="ss">Apache</span><span class="p">:</span><span class="ss">:PROXYREQ_REVERSE</span>
<span class="n">r</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">"proxy:"</span> <span class="o">+</span> <span class="n">backends</span><span class="o">[</span><span class="nb">rand</span><span class="p">(</span><span class="n">backends</span><span class="o">.</span><span class="n">length</span><span class="p">)</span><span class="o">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">uri</span>

<span class="ss">Apache</span><span class="p">:</span><span class="ss">:return</span><span class="p">(</span><span class="ss">Apache</span><span class="p">:</span><span class="ss">:OK</span><span class="p">)</span>
</pre></div>

<ul>
<li>see <a href="https://github.com/matsumoto-r/mod_mruby/tree/master/example">example</a>
</li>
<li><strong>Sample of Unified Ruby Code between Apache(mod_mruby) and nginx(ngx_mruby) for Web server extensions</strong></li>
<li>You can implement some Web server software extensions by same Ruby code (as possible) </li>
</ul><div class="highlight highlight-ruby"><pre><span class="c1"># Unified Ruby Code between Apache(mod_mruby) and nginx(ngx_mruby)</span>
<span class="c1"># for Web server extensions.</span>
<span class="c1">#</span>
<span class="c1"># Apache httpd.conf by mod_mruby</span>
<span class="c1"># </span>
<span class="c1"># &lt;Location /mruby&gt;</span>
<span class="c1">#     mrubyHandlerMiddle "/path/to/unified_hello.rb"</span>
<span class="c1"># &lt;/Location&gt;</span>
<span class="c1">#</span>
<span class="c1"># nginx ngxin.conf by ngx_mruby</span>
<span class="c1">#</span>
<span class="c1"># location /mruby {</span>
<span class="c1">#     mruby_content_handler "/path/to/unified_hello.rb";</span>
<span class="c1"># }</span>
<span class="c1">#</span>

<span class="k">if</span> <span class="n">server_name</span> <span class="o">==</span> <span class="s2">"NGINX"</span>
  <span class="no">Server</span> <span class="o">=</span> <span class="no">Nginx</span>
<span class="k">elsif</span> <span class="n">server_name</span> <span class="o">==</span> <span class="s2">"Apache"</span>
  <span class="no">Server</span> <span class="o">=</span> <span class="no">Apache</span>
<span class="k">end</span>

<span class="ss">Server</span><span class="p">:</span><span class="ss">:rputs</span> <span class="s2">"Hello </span><span class="si">#{</span><span class="ss">Server</span><span class="p">:</span><span class="ss">:module_name</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="ss">Server</span><span class="p">:</span><span class="ss">:module_version</span><span class="si">}</span><span class="s2"> world!"</span>
<span class="c1"># mod_mruby =&gt; "Hello mod_mruby/0.9.3 world!"</span>
<span class="c1"># ngx_mruby =&gt; "Hello ngx_mruby/0.0.1 world!"</span>
</pre></div>

<h2>
<a name="abstract" class="anchor" href="#abstract"><span class="octicon octicon-link"></span></a>Abstract</h2>

<p>As the increase of large-scale and complex Web services, not only a development of Web applications but also an implementation of Web server extensions is required in many cases. The Web server extensions were mainly implemented in C language because of fast and memory-efficient behavior, but extension methods using scripting language are proposed with consideration of maintainability and productivity. However, if the existing methods primarily intended to enhance not the implementation of Web applications but the implementation of internal processing of the Web server, the problem remains in terms of fast, memory-efficiency and safety. Therefore, we propose a fast and memory-efficient Web server extension mechanism using scripting language. We design the architecture that a server process create the region to save the state of the interpreter at the server process startup, and multiple scripts share the region in order to process fast when the script is called as internal processing from a Web server process. The server process free the global variables table, the exception flag and the byte-code which cause the increase of memory usage mainly, in order to reduce the memory usage and extend safely by preventing interference between each scripts because of sharing the region. We implement the mechanism that can extend the internal processing of Apache easily by Ruby scripts using Apache and embeddable scripting language mruby. It's called "mod_mruby".</p>

<h2>
<a name="how-to-use" class="anchor" href="#how-to-use"><span class="octicon octicon-link"></span></a>How to use</h2>

<h3>
<a name="1-download" class="anchor" href="#1-download"><span class="octicon octicon-link"></span></a>1. Download</h3>

<pre><code>git clone git://github.com/matsumoto-r/mod_mruby.git
</code></pre>

<h3>
<a name="2-auto-build" class="anchor" href="#2-auto-build"><span class="octicon octicon-link"></span></a>2. Auto Build</h3>

<pre><code>cd mod_mruby
sh build.sh
</code></pre>

<h3>
<a name="3-test-settings" class="anchor" href="#3-test-settings"><span class="octicon octicon-link"></span></a>3. Test Settings</h3>

<ul>
<li>
<p>Add to httpd.conf</p>

<div class="highlight highlight-apache"><pre><span class="nb">LoadModule</span> mruby_module modules/mod_mruby.so
<span class="nb">AddHandler</span> mruby-script .rb  
</pre></div>

<p>or hook from a handler phase</p>

<div class="highlight highlight-apache"><pre><span class="nb">LoadModule</span> mruby_module modules/mod_mruby.so
<span class="nt">&lt;Location</span> <span class="s">/mruby-test</span><span class="nt">&gt;</span>
    <span class="nb">mrubyHandlerMiddle</span> <span class="sx">/path/to/test.rb</span>
<span class="nt">&lt;/Location&gt;</span>
</pre></div>

<p>or cache enabled</p>

<div class="highlight highlight-apache"><pre><span class="nb">LoadModule</span> mruby_module modules/mod_mruby.so
<span class="nt">&lt;Location</span> <span class="s">/mruby-test</span><span class="nt">&gt;</span>
    <span class="nb">mrubyHandlerMiddle</span> <span class="sx">/path/to/test.rb</span> cache
<span class="nt">&lt;/Location&gt;</span>
</pre></div>
</li>
<li>
<p>test.rb copy   </p>

<pre><code>cp -p test/test.rb $(APACHE_DOCMENT_ROOT)/.
</code></pre>
</li>
</ul><h3>
<a name="4-apache-restart" class="anchor" href="#4-apache-restart"><span class="octicon octicon-link"></span></a>4. Apache Restart</h3>

<pre><code>service httpd restart
</code></pre>

<h3>
<a name="5-access-url-by-browser" class="anchor" href="#5-access-url-by-browser"><span class="octicon octicon-link"></span></a>5. Access URL by Browser</h3>

<pre><code>curl http://127.0.0.1/test.rb
</code></pre>

<p>or</p>

<pre><code>curl http://127.0.0.1/mruby-test
</code></pre>

<h3>
<a name="manual-build" class="anchor" href="#manual-build"><span class="octicon octicon-link"></span></a>Manual Build</h3>

<ul>
<li>
<p>mruby/mruby build</p>

<pre><code>cd mod_mruby
git submodule init
git submodule update
cd mruby
rake
cd ..
</code></pre>
</li>
<li>
<p>configure</p>

<pre><code>./configure
</code></pre>
</li>
<li>
<p>using mruby/mruby</p>

<pre><code>make
make install
</code></pre>
</li>
</ul><h2>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h2>

<ul>
<li>
<p>Selecting vhost area like mod_vhost_alias(hook on translatename)</p>

<div class="highlight highlight-ruby"><pre><span class="n">r</span> <span class="o">=</span> <span class="ss">Apache</span><span class="p">:</span><span class="ss">:Request</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">s</span> <span class="o">=</span> <span class="ss">Apache</span><span class="p">:</span><span class="ss">:Server</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">document_root</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">hostname</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">uri</span>

<span class="ss">Apache</span><span class="p">:</span><span class="ss">:return</span><span class="p">(</span><span class="ss">Apache</span><span class="p">:</span><span class="ss">:OK</span><span class="p">)</span>
</pre></div>
</li>
<li>
<p>Proxy balancer like mod_proxy_balancer(hook on translatename)</p>

<div class="highlight highlight-ruby"><pre><span class="n">backends</span> <span class="o">=</span> <span class="o">[</span>
    <span class="s2">"http://192.168.0.101:8888/"</span><span class="p">,</span>
    <span class="s2">"http://192.168.0.102:8888/"</span><span class="p">,</span>
    <span class="s2">"http://192.168.0.103:8888/"</span><span class="p">,</span>
    <span class="s2">"http://192.168.0.104:8888/"</span><span class="p">,</span>
<span class="o">]</span>

<span class="c1"># write balancing algorithm here.</span>

<span class="n">r</span> <span class="o">=</span> <span class="ss">Apache</span><span class="p">:</span><span class="ss">:Request</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">handler</span>  <span class="o">=</span> <span class="s2">"proxy-server"</span>
<span class="n">r</span><span class="o">.</span><span class="n">proxyreq</span> <span class="o">=</span> <span class="ss">Apache</span><span class="p">:</span><span class="ss">:PROXYREQ_REVERSE</span>
<span class="n">r</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">"proxy:"</span> <span class="o">+</span> <span class="n">backends</span><span class="o">[</span><span class="nb">rand</span><span class="p">(</span><span class="n">backends</span><span class="o">.</span><span class="n">length</span><span class="p">)</span><span class="o">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">uri</span>

<span class="ss">Apache</span><span class="p">:</span><span class="ss">:return</span><span class="p">(</span><span class="ss">Apache</span><span class="p">:</span><span class="ss">:OK</span><span class="p">)</span>
</pre></div>
</li>
</ul><h2>
<a name="functions" class="anchor" href="#functions"><span class="octicon octicon-link"></span></a>Functions</h2>

<ul>
<li><a href="https://github.com/matsumoto-r/mod_mruby/wiki/Functions">Functions Page</a></li>
</ul><h2>
<a name="data-structure" class="anchor" href="#data-structure"><span class="octicon octicon-link"></span></a>Data Structure</h2>

<ul>
<li><a href="https://github.com/matsumoto-r/mod_mruby/wiki/Data-Structure">Data Structure Page</a></li>
</ul><h1>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h1>

<p>under the MIT License:</p>

<ul>
<li><a href="http://www.opensource.org/licenses/mit-license.php">http://www.opensource.org/licenses/mit-license.php</a></li>
</ul>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>